# EzPC Code Generation and Usage

This directory contains scripts and code necessary to create and run an EzPC version of an LSTM training regime over the USPS 10 dataset.

## Structure

* The `autogen` directory will contain automatically generated code and input files.
* The `build` directory will contain the complete LSTM training application in EzPC.
* The `manual` directory contains some manually written code.
  * `constants.ezpc` contains some constants such as information about the inputs and the LSTM hyperparameters.
  * `fxplib.ezpc` contains many library functions used extensively throughout the autogenerated code.
  * `mainA.ezpc` through `mainD.ezpc` contain parts of the main function that are later merged with autogenerated code.
* `cat.sh` concatenates all generated and manually written EzPC files and writes it to `build/lstm.ezpc`.
* `fxpEzPCGen.py` is a library for autogenerating the forward and backward pass code in EzPC for a ML application.
* `lstmGenSpec.py` uses the `fxpEzPCGen` library to generate LSTM training code.
* `paramEzPCInput.py` generates initial random parameter values, to be read by the server side of a secure computation.
  In theory, the server could instead use pre-trained parameter values.
* `piecewiseEzPCGen.py` generates code to initialize piecewise polynomial coefficient arrays used by `fxplib`.
  Ideally, these arrays would be defined as global constant arrays instead.
  This would also simplify code generation and lead to slight speedups.
* `replaceextern-cpp.sh` and `replaceextern-sec.sh` replace some `extern` declarations in the EzPC code with actual C++ functions.
  They are for the plaintext and secure code generation targets, respectively.
* `uspsEzPCInput.py` converts the USPS 10 dataset into a format suitable for input into the EzPC application.

## Prerequisites

* You must have EzPC installed.
  You will have to alter the commands shown here slightly depending on your exact EzPC install location.
* You need to setup the USPS 10 dataset in the `data` directory in the root folder beforehand.

## Instructions

1. Create the following subdirectories in the `EzPC` directory: `autogen` and `build`
1. Run `paramEzPCInput.py`, `piecewiseEzPCGen.py`, and `uspsEzPCInput.py` to autogenerate some input files.
2. Run `lstmGenSpec.py` to autogenerate LSTM training code.
3. Run `cat.sh` to combine all EzPC files into a single file as required by EzPC.
4. Compile with EzPC.
  * Secure: Run `ezpc.sh --bitlen 64 build/lstm.ezpc`
  * Plaintext: Run `ezpc.sh --bitlen 64 --codegen CPP build/lstm.ezpc`
5. Replace external functions.
  * Secure: Run `replaceextern-sec.sh`
  * Plaintext: Run `replaceextern-cpp.sh`
6. Compile the C++ code.
  * Secure: Run `compile_aby.sh build/lstm0.cpp` and copy the generated binary to `build`
  * Plaintext: Run `g++ -fconcepts build/lstm0.cpp -o build/lstm0`
7. Run the program.
  * Secure: In two seperate terminals, run `build/lstm0 -r 0 < autogen/params.server` and `build/lstm0 -r 1 < autogen/traintest.client`
  * Plaintext: Run `cat autogen/traintest.client autogen/params.server | build/lstm0`

## Issues

* The secure version consumes a large amount of memory and requires more than 16 GB RAM, perhaps much more.
  The plaintext version will comfortably run with 16 GB RAM.
* Not all training samples are used per epoch, and not all testing samples are used during verification.
  This is done to simplify the code so that the batch size is the same in all iterations.
  